<HTML>
<HEAD>
<TITLE>Listing of flash.c</TITLE>
<LINK rel=stylesheet href="udf_styles.css" type="text/css">
</HEAD>
<BODY>
<table class="">
<tr><td><code><i>     1</i> </code></td><td><code>&nbsp #if&nbsp defined(__XC)</code></td></tr>
<tr><td><code><i>     2</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  xc.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp XC8&nbsp General&nbsp Include&nbsp File&nbsp */</code></td></tr>
<tr><td><code><i>     3</i> </code></td><td><code>&nbsp #elif&nbsp defined(HI_TECH_C)</code></td></tr>
<tr><td><code><i>     4</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  htc.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp HiTech&nbsp General&nbsp Include&nbsp File&nbsp */</code></td></tr>
<tr><td><code><i>     5</i> </code></td><td><code>&nbsp #endif</code></td></tr>
<tr><td><code><i>     6</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  stdint.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp For&nbsp uint8_t&nbsp definition&nbsp */</code></td></tr>
<tr><td><code><i>     7</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  stdbool.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp For&nbsp true/false&nbsp definition&nbsp */</code></td></tr>
<tr><td><code><i>     8</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>     9</i> </code></td><td><code>&nbsp #include&nbsp "system.h"&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp System&nbsp funct/params,&nbsp like&nbsp osc/peripheral&nbsp config&nbsp */</code></td></tr>
<tr><td><code><i>    10</i> </code></td><td><code>&nbsp #include&nbsp "user.h"&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp User&nbsp funct/params,&nbsp such&nbsp as&nbsp InitApp&nbsp */</code></td></tr>
<tr><td><code><i>    11</i> </code></td><td><code>&nbsp #include&nbsp "flash.h"</code></td></tr>
<tr><td><code><i>    12</i> </code></td><td><code>&nbsp #include&nbsp "i2c.h"</code></td></tr>
<tr><td><code><i>    13</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    14</i> </code></td><td><code>&nbsp //****************************************************************</code></td></tr>
<tr><td><code><i>    15</i> </code></td><td><code>&nbsp //&nbsp&nbsp FLASH&nbsp MEMORY&nbsp READ</code></td></tr>
<tr><td><code><i>    16</i> </code></td><td><code>&nbsp //&nbsp&nbsp needs&nbsp 16&nbsp bit&nbsp address&nbsp pointer&nbsp in&nbsp address</code></td></tr>
<tr><td><code><i>    17</i> </code></td><td><code>&nbsp //&nbsp&nbsp returns&nbsp 14&nbsp bit&nbsp value&nbsp from&nbsp selected&nbsp address</code></td></tr>
<tr><td><code><i>    18</i> </code></td><td><code>&nbsp //</code></td></tr>
<tr><td><code><i>    19</i> </code></td><td><code>&nbsp //****************************************************************</code></td></tr>
<tr><td><code><i>    20</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    21</i> </code></td><td><code>&nbsp unsigned&nbsp int&nbsp flash_memory_read(unsigned&nbsp int&nbsp address)&nbsp {</code></td></tr>
<tr><td><code><i>    22</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEADRL&nbsp =&nbsp ((address)&0xff);</code></td></tr>
<tr><td><code><i>    23</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEADRH&nbsp =&nbsp ((address)&nbsp&rsaquo &rsaquo &nbsp 8);</code></td></tr>
<tr><td><code><i>    24</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp CFGS&nbsp =&nbsp 0;&nbsp //&nbsp access&nbsp FLASH&nbsp program,&nbsp not&nbsp config</code></td></tr>
<tr><td><code><i>    25</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEPGD&nbsp =&nbsp 1;</code></td></tr>
<tr><td><code><i>    26</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp LWLO&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>    27</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp RD&nbsp =&nbsp 1;</code></td></tr>
<tr><td><code><i>    28</i> </code></td><td><code>&nbsp #asm</code></td></tr>
<tr><td><code><i>    29</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp NOP</code></td></tr>
<tr><td><code><i>    30</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp NOP</code></td></tr>
<tr><td><code><i>    31</i> </code></td><td><code>&nbsp #endasm</code></td></tr>
<tr><td><code><i>    32</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp return&nbsp (&nbsp (EEDATL)&nbsp&lsaquo &lsaquo &nbsp 8&nbsp |&nbsp (EEDATH));</code></td></tr>
<tr><td><code><i>    33</i> </code></td><td><code>&nbsp }</code></td></tr>
<tr><td><code><i>    34</i> </code></td><td><code>&nbsp //****************************************************************</code></td></tr>
<tr><td><code><i>    35</i> </code></td><td><code>&nbsp //&nbsp&nbsp FLASH&nbsp MEMORY&nbsp WRITE</code></td></tr>
<tr><td><code><i>    36</i> </code></td><td><code>&nbsp //&nbsp&nbsp needs&nbsp 16&nbsp bit&nbsp address&nbsp pointer&nbsp in&nbsp address,&nbsp 16&nbsp bit&nbsp data&nbsp pointer</code></td></tr>
<tr><td><code><i>    37</i> </code></td><td><code>&nbsp //</code></td></tr>
<tr><td><code><i>    38</i> </code></td><td><code>&nbsp //****************************************************************</code></td></tr>
<tr><td><code><i>    39</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    40</i> </code></td><td><code>&nbsp void&nbsp flash_memory_write(unsigned&nbsp int&nbsp address,&nbsp unsigned&nbsp char&nbsp *data)&nbsp {</code></td></tr>
<tr><td><code><i>    41</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp unsigned&nbsp char&nbsp wdi;</code></td></tr>
<tr><td><code><i>    42</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EECON1&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>    43</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEADRL&nbsp =&nbsp ((address)&0xff);&nbsp //&nbsp load&nbsp address</code></td></tr>
<tr><td><code><i>    44</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEADRH&nbsp =&nbsp ((address)&nbsp&rsaquo &rsaquo &nbsp 8);&nbsp //&nbsp load&nbsp address</code></td></tr>
<tr><td><code><i>    45</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEPGD&nbsp =&nbsp 1;&nbsp //&nbsp access&nbsp program&nbsp space&nbsp FLASH&nbsp memory</code></td></tr>
<tr><td><code><i>    46</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp CFGS&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>    47</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp ;&nbsp //&nbsp access&nbsp FLASH&nbsp program,&nbsp not&nbsp config</code></td></tr>
<tr><td><code><i>    48</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp WREN&nbsp =&nbsp 1;&nbsp //&nbsp allow&nbsp program/erase</code></td></tr>
<tr><td><code><i>    49</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp LWLO&nbsp =&nbsp 1;</code></td></tr>
<tr><td><code><i>    50</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp for&nbsp (wdi&nbsp =&nbsp 0;&nbsp wdi&nbsp&lsaquo &nbsp FLASH_BLOCK_BYTES;&nbsp wdi&nbsp +=&nbsp 2)&nbsp {</code></td></tr>
<tr><td><code><i>    51</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp EEDATL&nbsp =&nbsp data[wdi];</code></td></tr>
<tr><td><code><i>    52</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp EEDATH&nbsp =&nbsp data[wdi&nbsp +&nbsp 1];</code></td></tr>
<tr><td><code><i>    53</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp EECON2&nbsp =&nbsp 0x55;</code></td></tr>
<tr><td><code><i>    54</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp EECON2&nbsp =&nbsp 0xAA;</code></td></tr>
<tr><td><code><i>    55</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp WR&nbsp =&nbsp 1;&nbsp //&nbsp set&nbsp WR&nbsp to&nbsp begin&nbsp write</code></td></tr>
<tr><td><code><i>    56</i> </code></td><td><code>&nbsp #asm</code></td></tr>
<tr><td><code><i>    57</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp NOP</code></td></tr>
<tr><td><code><i>    58</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp NOP</code></td></tr>
<tr><td><code><i>    59</i> </code></td><td><code>&nbsp #endasm</code></td></tr>
<tr><td><code><i>    60</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp EEADR++;</code></td></tr>
<tr><td><code><i>    61</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    62</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEADR--;</code></td></tr>
<tr><td><code><i>    63</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp LWLO&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>    64</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EECON2&nbsp =&nbsp 0x55;</code></td></tr>
<tr><td><code><i>    65</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EECON2&nbsp =&nbsp 0xAA;</code></td></tr>
<tr><td><code><i>    66</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp WR&nbsp =&nbsp 1;&nbsp //&nbsp set&nbsp WR&nbsp to&nbsp begin&nbsp write</code></td></tr>
<tr><td><code><i>    67</i> </code></td><td><code>&nbsp #asm</code></td></tr>
<tr><td><code><i>    68</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp NOP</code></td></tr>
<tr><td><code><i>    69</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp NOP</code></td></tr>
<tr><td><code><i>    70</i> </code></td><td><code>&nbsp #endasm</code></td></tr>
<tr><td><code><i>    71</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp WREN&nbsp =&nbsp 0;&nbsp //&nbsp disallow&nbsp program/erase</code></td></tr>
<tr><td><code><i>    72</i> </code></td><td><code>&nbsp }</code></td></tr>
<tr><td><code><i>    73</i> </code></td><td><code>&nbsp //****************************************************************</code></td></tr>
<tr><td><code><i>    74</i> </code></td><td><code>&nbsp //&nbsp&nbsp FLASH&nbsp MEMORY&nbsp ERASE</code></td></tr>
<tr><td><code><i>    75</i> </code></td><td><code>&nbsp //&nbsp&nbsp Program&nbsp memory&nbsp can&nbsp only&nbsp be&nbsp erased&nbsp by&nbsp rows.</code></td></tr>
<tr><td><code><i>    76</i> </code></td><td><code>&nbsp //&nbsp&nbsp A&nbsp row&nbsp consists&nbsp of&nbsp 32&nbsp words&nbsp where&nbsp the&nbsp EEADRL&lsaquo  4:0&rsaquo &nbsp =&nbsp 0000.</code></td></tr>
<tr><td><code><i>    77</i> </code></td><td><code>&nbsp //</code></td></tr>
<tr><td><code><i>    78</i> </code></td><td><code>&nbsp //****************************************************************</code></td></tr>
<tr><td><code><i>    79</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    80</i> </code></td><td><code>&nbsp void&nbsp flash_memory_erase(unsigned&nbsp int&nbsp address)&nbsp {</code></td></tr>
<tr><td><code><i>    81</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEADRL&nbsp =&nbsp ((address)&0xff);&nbsp //&nbsp load&nbsp address</code></td></tr>
<tr><td><code><i>    82</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEADRH&nbsp =&nbsp ((address)&nbsp&rsaquo &rsaquo &nbsp 8);&nbsp //&nbsp load&nbsp address</code></td></tr>
<tr><td><code><i>    83</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp CFGS&nbsp =&nbsp 0;&nbsp //&nbsp access&nbsp FLASH&nbsp program,&nbsp not&nbsp config</code></td></tr>
<tr><td><code><i>    84</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp LWLO&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>    85</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp WREN&nbsp =&nbsp 1;&nbsp //&nbsp allow&nbsp program/erase</code></td></tr>
<tr><td><code><i>    86</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EEPGD&nbsp =&nbsp 1;&nbsp //&nbsp access&nbsp program&nbsp space&nbsp FLASH&nbsp memory</code></td></tr>
<tr><td><code><i>    87</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp FREE&nbsp =&nbsp 1;&nbsp //&nbsp perform&nbsp an&nbsp erase&nbsp on&nbsp next&nbsp WR&nbsp command,&nbsp cleared&nbsp by&nbsp hardware</code></td></tr>
<tr><td><code><i>    88</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EECON2&nbsp =&nbsp 0x55;&nbsp //&nbsp required&nbsp sequence</code></td></tr>
<tr><td><code><i>    89</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp EECON2&nbsp =&nbsp 0xAA;&nbsp //&nbsp required&nbsp sequence</code></td></tr>
<tr><td><code><i>    90</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp WR&nbsp =&nbsp 1;&nbsp //&nbsp set&nbsp WR&nbsp to&nbsp begin&nbsp erase&nbsp cycle</code></td></tr>
<tr><td><code><i>    91</i> </code></td><td><code>&nbsp #asm</code></td></tr>
<tr><td><code><i>    92</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp NOP</code></td></tr>
<tr><td><code><i>    93</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp NOP</code></td></tr>
<tr><td><code><i>    94</i> </code></td><td><code>&nbsp #endasm</code></td></tr>
<tr><td><code><i>    95</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp WREN&nbsp =&nbsp 0;&nbsp //&nbsp disallow&nbsp program/erase</code></td></tr>
<tr><td><code><i>    96</i> </code></td><td><code>&nbsp }</code></code></BODY>
</HTML>
