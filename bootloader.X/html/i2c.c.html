<HTML>
<HEAD>
<TITLE>Listing of i2c.c</TITLE>
<LINK rel=stylesheet href="udf_styles.css" type="text/css">
</HEAD>
<BODY>
<table class="">
<tr><td><code><i>     1</i> </code></td><td><code>&nbsp #if&nbsp defined(__XC)</code></td></tr>
<tr><td><code><i>     2</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  xc.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp XC8&nbsp General&nbsp Include&nbsp File&nbsp */</code></td></tr>
<tr><td><code><i>     3</i> </code></td><td><code>&nbsp #elif&nbsp defined(HI_TECH_C)</code></td></tr>
<tr><td><code><i>     4</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  htc.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp 8&nbsp&nbsp&nbsp /*&nbsp HiTech&nbsp General&nbsp Include&nbsp File&nbsp */</code></td></tr>
<tr><td><code><i>     5</i> </code></td><td><code>&nbsp #endif</code></td></tr>
<tr><td><code><i>     6</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  stdint.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp For&nbsp uint8_t&nbsp definition&nbsp */</code></td></tr>
<tr><td><code><i>     7</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  stdbool.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp For&nbsp true/false&nbsp definition&nbsp */</code></td></tr>
<tr><td><code><i>     8</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>     9</i> </code></td><td><code>&nbsp #include&nbsp "system.h"&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp System&nbsp funct/params,&nbsp like&nbsp osc/peripheral&nbsp config&nbsp */</code></td></tr>
<tr><td><code><i>    10</i> </code></td><td><code>&nbsp #include&nbsp "user.h"&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp User&nbsp funct/params,&nbsp such&nbsp as&nbsp InitApp&nbsp */</code></td></tr>
<tr><td><code><i>    11</i> </code></td><td><code>&nbsp #include&nbsp "flash.h"</code></td></tr>
<tr><td><code><i>    12</i> </code></td><td><code>&nbsp #include&nbsp "i2c.h"</code></td></tr>
<tr><td><code><i>    13</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    14</i> </code></td><td><code>&nbsp #ifdef&nbsp _12F1840</code></td></tr>
<tr><td><code><i>    15</i> </code></td><td><code>&nbsp #define&nbsp SSPIF&nbsp SSP1IF</code></td></tr>
<tr><td><code><i>    16</i> </code></td><td><code>&nbsp #endif</code></td></tr>
<tr><td><code><i>    17</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    18</i> </code></td><td><code>&nbsp void&nbsp _WriteData(unsigned&nbsp char&nbsp data)&nbsp {</code></td></tr>
<tr><td><code><i>    19</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp do&nbsp {</code></td></tr>
<tr><td><code><i>    20</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp WCOL&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>    21</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp SSPBUF&nbsp =&nbsp data;</code></td></tr>
<tr><td><code><i>    22</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp }&nbsp while&nbsp (WCOL);</code></td></tr>
<tr><td><code><i>    23</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp CKP&nbsp =&nbsp 1;</code></td></tr>
<tr><td><code><i>    24</i> </code></td><td><code>&nbsp }</code></td></tr>
<tr><td><code><i>    25</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    26</i> </code></td><td><code>&nbsp void&nbsp do_i2c_tasks()&nbsp {</code></td></tr>
<tr><td><code><i>    27</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp unsigned&nbsp int&nbsp dat&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>    28</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp unsigned&nbsp char&nbsp temp,&nbsp idx;</code></td></tr>
<tr><td><code><i>    29</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp if&nbsp (SSPIF)&nbsp {</code></td></tr>
<tr><td><code><i>    30</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (SSPSTATbits.S)&nbsp {</code></td></tr>
<tr><td><code><i>    31</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (SSPSTATbits.D_nA&nbsp &&&nbsp !SSPSTATbits.BF&nbsp &&&nbsp CKP)&nbsp {&nbsp //&nbsp Master&nbsp NACK</code></td></tr>
<tr><td><code><i>    32</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp goto&nbsp stop;</code></td></tr>
<tr><td><code><i>    33</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (!SSPSTATbits.R_nW&nbsp &&&nbsp !SSPSTATbits.D_nA&nbsp &&&nbsp SSPSTATbits.BF)&nbsp {&nbsp //MASTER&nbsp WRITES&nbsp ADDRESS&nbsp STATE</code></td></tr>
<tr><td><code><i>    34</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp Disable&nbsp timeout</code></td></tr>
<tr><td><code><i>    35</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp OPTION_REG&nbsp =&nbsp 0b11111111;</code></td></tr>
<tr><td><code><i>    36</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp temp&nbsp =&nbsp SSPBUF;</code></td></tr>
<tr><td><code><i>    37</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp pksa_status&nbsp =&nbsp I2C_SLAVE_ADDRESS_RECEIVED;</code></td></tr>
<tr><td><code><i>    38</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (!SSPSTATbits.R_nW&nbsp &&&nbsp SSPSTATbits.D_nA&nbsp &&&nbsp SSPSTATbits.BF)&nbsp {&nbsp //&nbsp MWD:&nbsp //MASTER&nbsp WRITES&nbsp DATA&nbsp STATE</code></td></tr>
<tr><td><code><i>    39</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp temp&nbsp =&nbsp SSPBUF;</code></td></tr>
<tr><td><code><i>    40</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (pksa_status&nbsp ==&nbsp I2C_SLAVE_ADDRESS_RECEIVED)&nbsp {&nbsp //&nbsp first&nbsp time&nbsp we&nbsp get&nbsp the&nbsp slave&nbsp address,&nbsp after&nbsp that&nbsp set&nbsp to&nbsp word&nbsp address</code></td></tr>
<tr><td><code><i>    41</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp pksa_wd_address&nbsp =&nbsp temp;</code></td></tr>
<tr><td><code><i>    42</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp pksa_index&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>    43</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp pksa_status&nbsp =&nbsp I2C_WORD_ADDRESS_RECEIVED;</code></td></tr>
<tr><td><code><i>    44</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (pksa_status&nbsp ==&nbsp I2C_WORD_ADDRESS_RECEIVED)&nbsp {&nbsp //&nbsp second&nbsp time&nbsp we&nbsp get&nbsp the&nbsp word&nbsp address,&nbsp so&nbsp look&nbsp into&nbsp word&nbsp address</code></td></tr>
<tr><td><code><i>    45</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (pksa_wd_address&nbsp ==&nbsp 0x01)&nbsp {&nbsp //&nbsp 0x01&nbsp is&nbsp buffer&nbsp word&nbsp address</code></td></tr>
<tr><td><code><i>    46</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (pksa_index&nbsp ==&nbsp 0)&nbsp {</code></td></tr>
<tr><td><code><i>    47</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_addr_pointer.bytes.byte_L&nbsp =&nbsp temp;</code></td></tr>
<tr><td><code><i>    48</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp pksa_index++;</code></td></tr>
<tr><td><code><i>    49</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (pksa_index&nbsp ==&nbsp 1)&nbsp {</code></td></tr>
<tr><td><code><i>    50</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_addr_pointer.bytes.byte_H&nbsp =&nbsp temp;</code></td></tr>
<tr><td><code><i>    51</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    52</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (pksa_wd_address&nbsp ==&nbsp 0x02)&nbsp {&nbsp //&nbsp 0x02&nbsp write&nbsp data&nbsp word&nbsp address</code></td></tr>
<tr><td><code><i>    53</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (pksa_index&nbsp&lsaquo &nbsp FLASH_BLOCK_BYTES)&nbsp {</code></td></tr>
<tr><td><code><i>    54</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_buffer[pksa_index]&nbsp =&nbsp temp;</code></td></tr>
<tr><td><code><i>    55</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    56</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp pksa_index++;</code></td></tr>
<tr><td><code><i>    57</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    58</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    59</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (SSPSTATbits.R_nW&nbsp &&&nbsp !SSPSTATbits.D_nA)&nbsp {&nbsp //MASTER&nbsp READS&nbsp ADDRESS&nbsp STATE</code></td></tr>
<tr><td><code><i>    60</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp Disable&nbsp timeout</code></td></tr>
<tr><td><code><i>    61</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp OPTION_REG&nbsp =&nbsp 0b11111111;</code></td></tr>
<tr><td><code><i>    62</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (pksa_wd_address&nbsp ==&nbsp 0x01)&nbsp {&nbsp //&nbsp buffer&nbsp word&nbsp address</code></td></tr>
<tr><td><code><i>    63</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp Send&nbsp first&nbsp byte&nbsp here,&nbsp next&nbsp byte&nbsp will&nbsp be&nbsp send&nbsp at&nbsp MRD&nbsp case,&nbsp see&nbsp below</code></td></tr>
<tr><td><code><i>    64</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp _WriteData(flash_addr_pointer.bytes.byte_L);</code></td></tr>
<tr><td><code><i>    65</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (pksa_wd_address&nbsp ==&nbsp 0x03)&nbsp {&nbsp //&nbsp read&nbsp data&nbsp from&nbsp flash&nbsp memory</code></td></tr>
<tr><td><code><i>    66</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (pksa_index&nbsp ==&nbsp 0)&nbsp {</code></td></tr>
<tr><td><code><i>    67</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp read&nbsp data&nbsp into&nbsp flash_buffer</code></td></tr>
<tr><td><code><i>    68</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp for&nbsp (idx&nbsp =&nbsp 0;&nbsp idx&nbsp&lsaquo &nbsp FLASH_BLOCK_BYTES;&nbsp idx&nbsp +=&nbsp 2)&nbsp {</code></td></tr>
<tr><td><code><i>    69</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp dat&nbsp =&nbsp flash_memory_read(flash_addr_pointer.word.address);</code></td></tr>
<tr><td><code><i>    70</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_buffer[idx&nbsp ]&nbsp =&nbsp dat&nbsp&rsaquo &rsaquo &nbsp 8;</code></td></tr>
<tr><td><code><i>    71</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_buffer[idx&nbsp +&nbsp 1]&nbsp =&nbsp dat&nbsp &&nbsp 0xFF;</code></td></tr>
<tr><td><code><i>    72</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_addr_pointer.word.address++;</code></td></tr>
<tr><td><code><i>    73</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    74</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp send&nbsp first&nbsp byte,&nbsp the&nbsp rest&nbsp will&nbsp be&nbsp sent&nbsp at&nbsp MRD,&nbsp see&nbsp below</code></td></tr>
<tr><td><code><i>    75</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp _WriteData(flash_buffer[pksa_index]);</code></td></tr>
<tr><td><code><i>    76</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp pksa_index++;</code></td></tr>
<tr><td><code><i>    77</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    78</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (pksa_wd_address&nbsp ==&nbsp 0x04)&nbsp {</code></td></tr>
<tr><td><code><i>    79</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp erase&nbsp command,&nbsp erases&nbsp a&nbsp row&nbsp of&nbsp ERASE_BLOCK_WORDS&nbsp words</code></td></tr>
<tr><td><code><i>    80</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_memory_erase(flash_addr_pointer.word.address);</code></td></tr>
<tr><td><code><i>    81</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_addr_pointer.word.address&nbsp +=&nbsp ERASE_BLOCK_WORDS;</code></td></tr>
<tr><td><code><i>    82</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp _WriteData(0x00);</code></td></tr>
<tr><td><code><i>    83</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (pksa_wd_address&nbsp ==&nbsp 0x05)&nbsp {</code></td></tr>
<tr><td><code><i>    84</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp write&nbsp command.&nbsp What's&nbsp stored&nbsp into&nbsp flash_buffer&nbsp is&nbsp written</code></td></tr>
<tr><td><code><i>    85</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp to&nbsp FLASH&nbsp memory&nbsp at&nbsp the&nbsp address&nbsp pointed&nbsp to&nbsp by&nbsp the&nbsp address&nbsp pointer.</code></td></tr>
<tr><td><code><i>    86</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp The&nbsp address&nbsp pointer&nbsp automatically&nbsp increments&nbsp by&nbsp FLASH_BLOCK_WORDS&nbsp units.</code></td></tr>
<tr><td><code><i>    87</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_memory_write(flash_addr_pointer.word.address,&nbsp flash_buffer);</code></td></tr>
<tr><td><code><i>    88</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp flash_addr_pointer.word.address&nbsp +=&nbsp FLASH_BLOCK_WORDS;</code></td></tr>
<tr><td><code><i>    89</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp _WriteData(0x00);</code></td></tr>
<tr><td><code><i>    90</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (pksa_wd_address&nbsp ==&nbsp 0x06)&nbsp {</code></td></tr>
<tr><td><code><i>    91</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp jump&nbsp to&nbsp appplication&nbsp code</code></td></tr>
<tr><td><code><i>    92</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp _WriteData(0xA0);</code></td></tr>
<tr><td><code><i>    93</i> </code></td><td><code>&nbsp appjmp:</code></td></tr>
<tr><td><code><i>    94</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp asm("reset");</code></td></tr>
<tr><td><code><i>    95</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    96</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (SSPSTATbits.R_nW&nbsp &&&nbsp SSPSTATbits.D_nA&nbsp &&&nbsp !SSPSTATbits.BF)&nbsp {&nbsp //MASTER&nbsp READS&nbsp DATA&nbsp STATE</code></td></tr>
<tr><td><code><i>    97</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (pksa_wd_address&nbsp ==&nbsp 0x01)&nbsp //&nbsp buffer&nbsp word&nbsp address</code></td></tr>
<tr><td><code><i>    98</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp {</code></td></tr>
<tr><td><code><i>    99</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp _WriteData(flash_addr_pointer.bytes.byte_H);</code></td></tr>
<tr><td><code><i>   100</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if&nbsp (pksa_wd_address&nbsp ==&nbsp 0x03)&nbsp {</code></td></tr>
<tr><td><code><i>   101</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (pksa_index&nbsp&lsaquo &nbsp FLASH_BLOCK_BYTES)&nbsp {</code></td></tr>
<tr><td><code><i>   102</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp _WriteData(flash_buffer[pksa_index]);</code></td></tr>
<tr><td><code><i>   103</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>   104</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp pksa_index++;</code></td></tr>
<tr><td><code><i>   105</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>   106</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>   107</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>   108</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if&nbsp (SSPSTATbits.P)&nbsp {&nbsp //STOP&nbsp or&nbsp NACK&nbsp state</code></td></tr>
<tr><td><code><i>   109</i> </code></td><td><code>&nbsp stop:</code></td></tr>
<tr><td><code><i>   110</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp reset&nbsp status&nbsp register</code></td></tr>
<tr><td><code><i>   111</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp SSPSTAT&nbsp =&nbsp 0b11000000;&nbsp //&nbsp Slew&nbsp rate&nbsp disabled&nbsp SSPSTAT:&nbsp&nbsp 8:SMP&nbsp&nbsp 7:CKE&nbsp&nbsp&nbsp&nbsp&nbsp 6:D/A&nbsp&nbsp&nbsp 5:P&nbsp&nbsp&nbsp&nbsp&nbsp 4:S&nbsp&nbsp&nbsp&nbsp 3:R/W&nbsp 2:UA&nbsp&nbsp&nbsp 1:BF</code></td></tr>
<tr><td><code><i>   112</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp pksa_status&nbsp =&nbsp I2C_NO_TRANSACTION;</code></td></tr>
<tr><td><code><i>   113</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>   114</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp SSPIF&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>   115</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp SSPEN&nbsp =&nbsp 1;</code></td></tr>
<tr><td><code><i>   116</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp CKP&nbsp =&nbsp 1;&nbsp //release&nbsp clock</code></td></tr>
<tr><td><code><i>   117</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp }&nbsp else&nbsp if(TMR0IF)&nbsp {</code></td></tr>
<tr><td><code><i>   118</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if(!(--timeout))&nbsp {</code></td></tr>
<tr><td><code><i>   119</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp goto&nbsp appjmp;</code></td></tr>
<tr><td><code><i>   120</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>   121</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp TMR0IF&nbsp =&nbsp 0;</code></td></tr>
<tr><td><code><i>   122</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>   123</i> </code></td><td><code>&nbsp }</code></BODY>
</HTML>
