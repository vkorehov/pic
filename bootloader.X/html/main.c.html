<HTML>
<HEAD>
<TITLE>Listing of main.c</TITLE>
<LINK rel=stylesheet href="udf_styles.css" type="text/css">
</HEAD>
<BODY>
<table class="">
<tr><td><code><i>     1</i> </code></td><td><code>&nbsp /******************************************************************************/</code></td></tr>
<tr><td><code><i>     2</i> </code></td><td><code>&nbsp /*&nbsp Files&nbsp to&nbsp Include&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp */</code></td></tr>
<tr><td><code><i>     3</i> </code></td><td><code>&nbsp /******************************************************************************/</code></td></tr>
<tr><td><code><i>     4</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>     5</i> </code></td><td><code>&nbsp #if&nbsp defined(__XC)</code></td></tr>
<tr><td><code><i>     6</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  xc.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp XC8&nbsp General&nbsp Include&nbsp File&nbsp */</code></td></tr>
<tr><td><code><i>     7</i> </code></td><td><code>&nbsp #elif&nbsp defined(HI_TECH_C)</code></td></tr>
<tr><td><code><i>     8</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  htc.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp HiTech&nbsp General&nbsp Include&nbsp File&nbsp */</code></td></tr>
<tr><td><code><i>     9</i> </code></td><td><code>&nbsp #endif</code></td></tr>
<tr><td><code><i>    10</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  stdint.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp For&nbsp uint8_t&nbsp definition&nbsp */</code></td></tr>
<tr><td><code><i>    11</i> </code></td><td><code>&nbsp #include&nbsp&lsaquo  stdbool.h&rsaquo &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp For&nbsp true/false&nbsp definition&nbsp */</code></td></tr>
<tr><td><code><i>    12</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    13</i> </code></td><td><code>&nbsp #include&nbsp "system.h"&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp System&nbsp funct/params,&nbsp like&nbsp osc/peripheral&nbsp config&nbsp */</code></td></tr>
<tr><td><code><i>    14</i> </code></td><td><code>&nbsp #include&nbsp "user.h"&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp /*&nbsp User&nbsp funct/params,&nbsp such&nbsp as&nbsp InitApp&nbsp */</code></td></tr>
<tr><td><code><i>    15</i> </code></td><td><code>&nbsp #include&nbsp "flash.h"&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp </code></td></tr>
<tr><td><code><i>    16</i> </code></td><td><code>&nbsp #include&nbsp "i2c.h"</code></td></tr>
<tr><td><code><i>    17</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    18</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    19</i> </code></td><td><code>&nbsp /******************************************************************************/</code></td></tr>
<tr><td><code><i>    20</i> </code></td><td><code>&nbsp /*&nbsp Main&nbsp Program&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp */</code></td></tr>
<tr><td><code><i>    21</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    22</i> </code></td><td><code>&nbsp /******************************************************************************/</code></td></tr>
<tr><td><code><i>    23</i> </code></td><td><code>&nbsp unsigned&nbsp char&nbsp flash_buffer[FLASH_BLOCK_BYTES];</code></td></tr>
<tr><td><code><i>    24</i> </code></td><td><code>&nbsp unsigned&nbsp char&nbsp pksa_wd_address;</code></td></tr>
<tr><td><code><i>    25</i> </code></td><td><code>&nbsp unsigned&nbsp char&nbsp pksa_index;</code></td></tr>
<tr><td><code><i>    26</i> </code></td><td><code>&nbsp unsigned&nbsp char&nbsp pksa_status;</code></td></tr>
<tr><td><code><i>    27</i> </code></td><td><code>&nbsp ADDRESS&nbsp flash_addr_pointer;</code></td></tr>
<tr><td><code><i>    28</i> </code></td><td><code>&nbsp unsigned&nbsp int&nbsp timeout&nbsp =&nbsp 0x1000;</code></td></tr>
<tr><td><code><i>    29</i> </code></td><td><code>&nbsp void&nbsp interrupt&nbsp isr(void)&nbsp {</code></td></tr>
<tr><td><code><i>    30</i> </code></td><td><code>&nbsp }</code></td></tr>
<tr><td><code><i>    31</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    32</i> </code></td><td><code>&nbsp #asm</code></td></tr>
<tr><td><code><i>    33</i> </code></td><td><code>&nbsp PSECT&nbsp intentry</code></td></tr>
<tr><td><code><i>    34</i> </code></td><td><code>&nbsp GOTO&nbsp 0x204</code></td></tr>
<tr><td><code><i>    35</i> </code></td><td><code>&nbsp #endasm</code></td></tr>
<tr><td><code><i>    36</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    37</i> </code></td><td><code>&nbsp void&nbsp main(void)&nbsp {</code></td></tr>
<tr><td><code><i>    38</i> </code></td><td><code>&nbsp </code></td></tr>
<tr><td><code><i>    39</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp if(&nbsp PCONbits.nRI&nbsp ==&nbsp 0)&nbsp {</code></td></tr>
<tr><td><code><i>    40</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp asm("goto&nbsp 0x200");</code></td></tr>
<tr><td><code><i>    41</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    42</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp //&nbsp Configure&nbsp to&nbsp 4&nbsp MHz</code></td></tr>
<tr><td><code><i>    43</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp OSCCON&nbsp =&nbsp 0b01101000;&nbsp //&nbsp 8:SPLLEN(0&nbsp by&nbsp confb)&nbsp 4..7:IRCF(1101&nbsp 4&nbsp MHz)&nbsp 1..2:SCS(00&nbsp use&nbsp FOSC&nbsp in&nbsp confbits)</code></td></tr>
<tr><td><code><i>    44</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp SSPSTAT&nbsp =&nbsp 0b11000000;&nbsp //&nbsp Slew&nbsp rate&nbsp disabled&nbsp SSPSTAT:&nbsp&nbsp 8:SMP&nbsp&nbsp 7:CKE&nbsp&nbsp&nbsp&nbsp&nbsp 6:D/A&nbsp&nbsp&nbsp 5:P&nbsp&nbsp&nbsp&nbsp&nbsp 4:S&nbsp&nbsp&nbsp&nbsp 3:R/W&nbsp 2:UA&nbsp&nbsp&nbsp 1:BF</code></td></tr>
<tr><td><code><i>    45</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp SSPADD&nbsp =&nbsp (unsigned&nbsp char)&nbsp (SLAVE_ADDR&nbsp&lsaquo &lsaquo &nbsp 1);&nbsp //&nbsp Slave&nbsp address</code></td></tr>
<tr><td><code><i>    46</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp SSPCON1&nbsp =&nbsp 0b00110110;&nbsp //&nbsp 8:WCOL(0)&nbsp 7:SSPOV(0)&nbsp 6:SSPEN(1)&nbsp 5:CKP(1)&nbsp 1..4:SSPM(0110&nbsp I2C&nbsp Slave&nbsp mode,&nbsp 7-bit&nbsp address))</code></td></tr>
<tr><td><code><i>    47</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp SSPCON2&nbsp =&nbsp 0b00000001;&nbsp //&nbsp 8:GCEN(0)&nbsp 7:ACKSTAT(0)&nbsp 6:ACKDT(0)&nbsp 5:ACKEN(0)&nbsp 4:RCEN(0)&nbsp 3:PEN(0)&nbsp 2:RSEN(0)&nbsp 1:SEN(0)</code></td></tr>
<tr><td><code><i>    48</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp SSPCON3&nbsp =&nbsp 0b01101000;&nbsp //&nbsp 8:ACKTIM(0)&nbsp 7:PCIE(1)&nbsp 6:SCIE(1)&nbsp 5:BOEN(1)&nbsp 4:SDAHT(1)&nbsp 3:SBCDE()&nbsp 2:AHEN(0)&nbsp 1:DHEN(1)</code></td></tr>
<tr><td><code><i>    49</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp timeout&nbsp =&nbsp 0x2000;</code></td></tr>
<tr><td><code><i>    50</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp OPTION_REG&nbsp =&nbsp 0x00;//&nbsp Enable&nbsp timer&nbsp 0</code></td></tr>
<tr><td><code><i>    51</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp //&nbsp main&nbsp program&nbsp loop</code></td></tr>
<tr><td><code><i>    52</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp while&nbsp (1)&nbsp {</code></td></tr>
<tr><td><code><i>    53</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp if(do_i2c_tasks())&nbsp {</code></td></tr>
<tr><td><code><i>    54</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp //&nbsp restore&nbsp POR&nbsp values</code></td></tr>
<tr><td><code><i>    55</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp OPTION_REG&nbsp =&nbsp 0b11111111;</code></td></tr>
<tr><td><code><i>    56</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp SSPSTAT&nbsp =&nbsp 0x00;&nbsp //&nbsp clear&nbsp status&nbsp register</code></td></tr>
<tr><td><code><i>    57</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp SSPADD&nbsp =&nbsp 0x00;&nbsp //&nbsp Slave&nbsp address</code></td></tr>
<tr><td><code><i>    58</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp SSPCON1&nbsp =&nbsp 0x00;&nbsp //&nbsp 8:WCOL(0)&nbsp 7:SSPOV(0)&nbsp 6:SSPEN(1)&nbsp 5:CKP(1)&nbsp 1..4:SSPM(0110&nbsp I2C&nbsp Slave&nbsp mode,&nbsp 7-bit&nbsp address))</code></td></tr>
<tr><td><code><i>    59</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp SSPCON2&nbsp =&nbsp 0x00;&nbsp //&nbsp 8:GCEN(0)&nbsp 7:ACKSTAT(0)&nbsp 6:ACKDT(0)&nbsp 5:ACKEN(0)&nbsp 4:RCEN(0)&nbsp 3:PEN(0)&nbsp 2:RSEN(0)&nbsp 1:SEN(0)</code></td></tr>
<tr><td><code><i>    60</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp SSPCON3&nbsp =&nbsp 0x00;&nbsp //&nbsp 8:ACKTIM(0)&nbsp 7:PCIE(1)&nbsp 6:SCIE(1)&nbsp 5:BOEN(1)&nbsp 4:SDAHT(1)&nbsp 3:SBCDE()&nbsp 2:AHEN(0)&nbsp 1:DHEN(1)</code></td></tr>
<tr><td><code><i>    61</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp OSCCON&nbsp =&nbsp 0b00111000;</code></td></tr>
<tr><td><code><i>    62</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp asm("reset");</code></td></tr>
<tr><td><code><i>    63</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    64</i> </code></td><td><code>&nbsp &nbsp&nbsp&nbsp&nbsp }</code></td></tr>
<tr><td><code><i>    65</i> </code></td><td><code>&nbsp }</code></BODY>
</HTML>
